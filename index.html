const redis = require("redis");
const express = require("express");
const client = redis.createClient();

client.on("error", function (error) {
  console.error(error);
});


const app = express()
app.use(express.urlencoded())
const port = 3000

app.get('/', (req, res) => {
  res.send('Hello World!');
})

app.get('/reports', (req, res) => {
  client.georadius('reports', 0, 0, 1000000, 'mi', (err, results) => {
    res.header('Content-Type', 'application/json');
    res.header('Access-Control-Allow-Origin', '*');
    res.send(results);
  });
});

app.post('/submit', (req, res) => {
  const coords = JSON.parse(req.body.coords);
  const payload = {
    type: req.body.offensetype,
    comments: req.body.comments,
    time: (new Date).getTime(),
    lng: coords.lng, lat: coords.lat
  }
  client.geoadd('reports', coords.lng, coords.lat, JSON.stringify(payload));
  res.send("Thank you for defending liberty.")
});

app.listen(port, () => console.log(`Example app listening at http://localhost:${port}`))
